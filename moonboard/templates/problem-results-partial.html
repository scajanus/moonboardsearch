
{% if problems %}
    <h4>{{ problems|length}} results <a href="#" id="resetSearch" style="color: #44F;" >(reset)</a></h4>
  {% for problem in problems %}
  <div class="match-{{problem.hold_count}}">
    <button class="list-group-item list-group-item-action justify-content-between d-flex align-items-center routeButton
    " id="{{problem.problem_id}}" onclick="toggleProblem('{{ problem.problem_id }}')">

    <span style="{% if problem.problem__rating == '1' or problem.problem__rating == '0'  %}
    font-style:italic
    {% elif problem.problem__rating == '3' %}
    font-weight:bold
    {% endif %}"><div style="">{{ problem.problem__name}}   <span class="badge badge-primary badge-pill repeats
      {% if problem.problem__repeats > 200 %}
      badge-success
      {% elif problem.problem__repeats <= 200 and problem.problem__repeats > 30  %}
      badge-warning
      {% elif problem.problem__repeats <= 30 %}
      badge-danger
      {% endif %}
      ">{{problem.problem__repeats}}</span></div>

  <span class="dateinserted">{{problem.date}}</span> <span class="howmany">{{ problem.hold_count}}/{{problem.total_holds}} holds</span>
  {% if problem.problem__method != 'Feet follow hands' %}<span class="method">({{problem.problem__method}})</span>{% endif %}</span>




      <span class="badge badge-primary badge-pill
      {% if problem.problem__grade|first == '6' %}
  badge-success
{% elif problem.problem__grade|first == '7' %}
  badge-warning
{% elif problem.problem__grade|first == '8' %}
  badge-danger
{% endif %}
      ">{{problem.problem__grade}}</span>

      </button>

  </div>
    <!-- <a id="problem.problem_id" title="Click to show {{ problem.problem__name }}"
    href="PleaseEnableJavascript.html" onclick="toggleRoute('{{ problem.problem_id }}');return false;">{{ problem.problem__name}} {{problem.problem__grade}}</a> -->
  {% endfor %}


<!--
{% if max_holds > 4 %}
<div class="slidecontainer mt-5">
  Overlap: <input type="range" min={{max_holds|add:"-2"}} max={{max_holds}} value={{min_overlap}} class="slider" id="foo" onchange="filterRoutes(this.value)">
</div>
{% endif %}
-->


{% endif %}

{% if max_holds > 3 %}
Minimum number of holds to match
<div class="slider-wrapper margin-wrapper" style="margin:10px 20px 50px 20px">
     <div id="slider2"></div>
 </div>
{% endif %}

{% if max_holds > 0 %}
Grade Filter
<div class="slider-wrapper margin-wrapper"  style="margin:0 20px 0 20px">
   <div id="slider"></div>
</div>
{% endif %}

{% if problems %}
<div class="filter-wrap" style="clear:both;  margin-top:50px">
              <!-- <div class="row section-header">

                   <div class="col-md-12">
                       <h3>
                           Filters
                       </h3>

                   </div>

               </div>



               <ul class="filters margin-wrapper">

                   <li>
                       <button class="filter" data-field="Myascents">My ascents</button>
                   </li>


                   <li>

                       <button class="filter" data-field="Setbyme">Set by me</button>
                   </li>
                   <li>

                       <button class="filter" data-field="Benchmarks">Benchmarks</button>

                   </li>
                   <li>

                       <button class="filter" data-field="None">Clear filters</button>
                   </li>

               </ul>-->

               <div class="row section-header">

                   <div class="col-md-12">
                       <h3>
                           Sort by

                       </h3>

                   </div>

               </div>

               <ul class="sort margin-wrapper">

                   <li>
                       <button class="sortBtn{% if sortedBy == "New" %} selected{% endif %}" data-field="New" data-dir="desc">New</button>
                   </li>


                   <li>

                       <button class="sortBtn{% if sortedBy == "Easy" %} selected{% endif %}" data-field="Easy" data-dir="asc">Easy</button>
                   </li>
                   <li>

                       <button class="sortBtn{% if sortedBy == "Num Holds" %} selected{% endif %}" data-field="Num Holds" data-dir="desc">Num Holds</button>

                   </li>
                   <li>

                       <button class="sortBtn{% if sortedBy == "Rating" %} selected{% endif %}" data-field="Rating" data-dir="desc">Rating</button>
                   </li>
                   <li>

                       <button class="sortBtn{% if sortedBy == "Repeats" %} selected{% endif %}" data-field="Repeats" data-dir="desc">Repeats</button>

                   </li>
                   <li>

                       <button class="sortBtn{% if sortedBy == "Screw Ons" %} selected{% endif %}" data-field="Screw Ons" data-dir="asc">Screw Ons</button>
                   </li>
               </ul>




               <ul class="sort margin-wrapper">
                   <li>
                       <button id="btnA" class="holdsetBtn{% if "A" in holdsetsSelected %} xselected{% endif %}" value="A">Holdset A (White)</button>
                   </li>
                   <li>
                       <button id="btnB" class="holdsetBtn{% if "B" in holdsetsSelected %} xselected{% endif %}" value="B">Holdset B (Black)</button>
                   </li>
                   {% if set_year == '2017' %}
                   <li>
                       <button id="btnC" class="holdsetBtn{% if "C" in holdsetsSelected %} xselected{% endif %}" value="C">Holdset C (Red)</button>
                   </li>
                   {% endif %}
                   {% if set_year == '2017' or set_year == '2019' %}
                   <li>
                       <button id="btnwood" class="holdsetBtn{% if "wood" in holdsetsSelected %} xselected{% endif %}" value="wood">Wood Holds</button>
                   </li>
                   {% endif %}
                   {% if set_year == '2019' %}
                   <li>
                       <button id="btnwoodB" class="holdsetBtn{% if "woodB" in holdsetsSelected %} xselected{% endif %}" value="wood">Wood Holds</button>
                   </li>
                   {% endif %}
                   {% if set_year == '2019' %}
                   <li>
                       <button id="btnwoodC" class="holdsetBtn{% if "woodC" in holdsetsSelected %} xselected{% endif %}" value="wood">Wood Holds</button>
                   </li>
                   {% endif %}
                   <li>
                       <button id="btnschool" class="holdsetBtn{% if "school" in holdsetsSelected %} xselected{% endif %}" value="school">School Room Holds</button>
                   </li>
               </ul>

               </div>
               {% else %}
                 <!--<p>No problems found.</p>-->
               {% endif %}
               <div class="filter-wrap" style="clear:both;  margin-top:50px">
               <p>To filter by one or more holds, click on the hold on the left side to select it (selections shown with blue circles). Once two or more holds are selected, this column will show the problems that  use those holds. </p>

               <p> Clicking on a hold again changes it  to red  which means "exclude this hold". Clicking again removes the hold from the search criteria.</p>

               <p>You may filter the holds by grade using the slider and also sort the holds using the buttons above. </p>

               <p>If you select more than four holds, a new slider will appear showing the minimum number of holds to match. This defaults to all of the holds you have chosen but you can reduce this. For instance if you chose 5 holds you can change the 'minimum number of holds ot match' to 4 and all problems that have at least four of your chosen holds will be displayed.</p>

               <p>Once the problems have been shown in the list, you can click on a single problem to show it on the right hand side.</p>
               </div>


                 <script type="text/javascript">


                    setYear = sessionStorage.getItem('setYear') || '2017';
                    var holdsetsSelectedjson = sessionStorage.getItem('holdsetsSelected')
                    if (holdsetsSelectedjson === null) {
                      if (setYear == '2016') {
                        holdsetsSelected = ['A','B','school']
                      } else if (setYear == '2017') {
                        holdsetsSelected = ['A','B','C','wood','school']
                      } else if  (setYear == '2019') {
                        holdsetsSelected = ['A','B','C','wood','school']
                      }
                      sessionStorage.setItem('holdsetsSelected', JSON.stringify(holdsetsSelected));
                    }
                    $('#btnA').removeClass('selected')
                    $('#btnB').removeClass('selected')
                    $('#btnC').removeClass('selected')
                    $('#btnwood').removeClass('selected')
                    $('#btnwoodB').removeClass('selected')
                    $('#btnwoodC').removeClass('selected')
                    $('#btnschool').removeClass('selected')
                    holdsetsSelected =  JSON.parse(holdsetsSelectedjson)
                    console.log('in selected setting' +  holdsetsSelected)
                    if (holdsetsSelected.includes('A')) { $('#btnA').addClass('selected') }
                    if (holdsetsSelected.includes('B')) { $('#btnB').addClass('selected') }
                    if (holdsetsSelected.includes('C')) { $('#btnC').addClass('selected') }
                    if (holdsetsSelected.includes('wood')) { $('#btnwood').addClass('selected') }
                    if (holdsetsSelected.includes('woodB')) { $('#btnwoodB').addClass('selected') }
                    if (holdsetsSelected.includes('woodC')) { $('#btnwoodC').addClass('selected') }
                    if (holdsetsSelected.includes('school')) { $('#btnschool').addClass('selected') }
                    backgroundcss = []
                    blendcss =  []

                    var arrayLength = holdsetsSelected.length;
                    for (var i = 0; i < arrayLength; i++) {
                        holdset = holdsetsSelected[i];
                        console.log('i'+holdset)
                        backgroundcss.push("url(/static/moonboard/" + setYear + "/" +  holdset +  ".png)")
                        blendcss.push('darken')
                    }
                    backgroundcss.push('url(/static/moonboard/moonboard-background.png)')
                    blendcss.push('normal')
                    $('#search-board').css('background-image', backgroundcss.join(',')).css('background-blend-mode', blendcss.join(','))
                    $('#result-board').css('background-image', backgroundcss.join(',')).css('background-blend-mode', blendcss.join(','))

                   {% if not max_holds %}
                       setYear = sessionStorage.getItem('setYear') || '2017';
                       if (setYear == '2016') {
                         holdsetsSelected = ['A','B','school']
                       } else if (setYear == '2017') {
                         holdsetsSelected = ['A','B','C','wood','school']
                       } else if  (setYear == '2019') {
                         holdsetsSelected = ['A','B','C','wood','school']
                       }
                        sessionStorage.setItem('holdsetsSelected', JSON.stringify(holdsetsSelected));
                        sessionStorage.setItem('minGrade','5+');
                        sessionStorage.setItem('maxGrade','8B+');
                        sessionStorage.setItem('minTick',0);
                        sessionStorage.setItem('maxTick',16);
                        sessionStorage.setItem('hold', JSON.stringify([]));
                        sessionStorage.setItem('nothold', JSON.stringify([]));

                    {%  endif %}

                   $("#resetSearch").on("click", function () {
                     console.log('resetclick')
                     $('#replaceable-name').html('Selected route')
                     document.getElementById("replaceable-content").scrollTop;
                     $('.result-board button').removeClass('blue-button red-button green-button');
                     $('#search-board button').removeClass('blue-button red-button green-button');

                     sessionStorage.setItem('hold', JSON.stringify([]))
                     sessionStorage.setItem('nothold', JSON.stringify([]))
                     setYear = sessionStorage.getItem('setYear') || '2017';
                     if (setYear == '2016') {
                       holdsetsSelected = ['A','B','school']
                     } else if (setYear == '2017') {
                       holdsetsSelected = ['A','B','C','wood','school']
                     } else if  (setYear == '2019') {
                       holdsetsSelected = ['A','B','C','wood','school']
                     }
                     sessionStorage.setItem('holdsetsSelected', JSON.stringify(holdsetsSelected));
                     getProblemList(holds=[], holdssetSelected=holdsetsSelected)

                   })

                   {% if max_holds > 3 %}
                   var minOverlapSlider = document.getElementById('slider2');
                   console.log('min_overlap ' + {{min_overlap}})
                   console.log('min_for_min_overlap_slider ' + {{min_for_min_overlap_slider}})
                   console.log('max_holds '+ {{max_holds}})
                   noUiSlider.create(minOverlapSlider, {
                       start: {{min_overlap}},
                       step: 1,
                       connect: 'lower',
                       range: {
                           'min': [{{min_for_min_overlap_slider}}],
                           'max': [{{max_holds}}]
                       },
                       pips: {
                        mode: 'steps',
                        density: 100

  }
                   });
                   {% endif %}


                    var holdsetups = JSON.parse('[{"Id":17,"Description":"MoonBoard Masters 2019","AllowClimbMethods":true,"MoonBoardConfigurations":[{"Id":1,"Description":"40° MoonBoard","LowGrade":"6A+","HighGrade":"8B+"},{"Id":2,"Description":"25° MoonBoard","LowGrade":"5+","HighGrade":"8B+"}]},{"Id":15,"Description":"MoonBoard Masters 2017","AllowClimbMethods":true,"MoonBoardConfigurations":[{"Id":1,"Description":"40° MoonBoard","LowGrade":"6A+","HighGrade":"8B+"},{"Id":2,"Description":"25° MoonBoard","LowGrade":"5+","HighGrade":"8B+"}]},{"Id":1,"Description":"MoonBoard 2016","AllowClimbMethods":false,"MoonBoardConfigurations":[]}]');







                     var ticks_labels = ["5+","6A","6A+","6B","6B+","6C","6C+","7A","7A+","7B","7B+","7C","7C+","8A","8A+","8B","8B+"];




                     var moonSlider = document.getElementById('slider');

                     var minGrade, maxGrade, minTick, maxTick;


                     minGrade = sessionStorage.getItem('minGrade') || '5+';
                     maxGrade = sessionStorage.getItem('maxGrade') || '8B+';
                     minTick = sessionStorage.getItem('minTick') || 0;
                     maxTick = sessionStorage.getItem('maxTick') || 16;

                     setYear = sessionStorage.getItem('setYear') || '2017';
                     setAngle = sessionStorage.getItem('setAngle') || '40';
                     holdsjson = sessionStorage.getItem('hold')
                     notholdsjson = sessionStorage.getItem('nothold')

                     sortedBy = sessionStorage.getItem('sortedBy');



                     console.log('{{maxholds}}',minGrade,maxGrade,minTick,maxTick, setYear, setAngle, sortedBy, holdsjson);

                     noUiSlider.create(moonSlider, {
                         start: [minTick, maxTick],
                         step: 1,
                         connect: true,
                         range: {
                             'min': [0],
                             'max': [16]
                         },
                         pips: {
                             mode: 'values',
                             values: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],
                             density: 17
                         }
                     });



                     var $sliderMin = $(".noUi-handle-lower");
                     var $sliderMax = $(".noUi-handle-upper");



                     function sliderValueChanged(values, handle, unencoded, tap, positions) {
                        console.log('sliderchanged',values);
                         var tMin = ticks_labels[parseInt(values[0])];
                         var tMax = ticks_labels[parseInt(values[1])];

                         if (minGrade != tMin || maxGrade != tMax) {



                             minGrade = tMin;
                             maxGrade = tMax;
                             sessionStorage.setItem('minTick', parseInt(values[0]));
                             sessionStorage.setItem('maxTick', parseInt(values[1]));

                             sessionStorage.setItem('minGrade', minGrade);
                             sessionStorage.setItem('maxGrade', maxGrade);


                         }
                         var setYear = sessionStorage.getItem('setYear') || '2017';
                         var setAngle = sessionStorage.getItem('setAngle') || '40';
                         var sortedBy = sessionStorage.getItem('sortedBy');

                         current_holdsetsSelected = sessionStorage.getItem('holdsetsSelected')
                         console.log('current_holdsetsSelected-prejson',current_holdsetsSelected)
                         if (holdsetsSelectedjson) {
                           current_holdsetsSelected = JSON.parse(holdsetsSelectedjson)
                         } else {
                           current_holdsetsSelected = []
                         }

                         holdsjson = sessionStorage.getItem('hold')
                         notholdsjson = sessionStorage.getItem('nothold')
                         var min_overlap = '{{min_overlap}}';
                         if (min_overlap) {
                           console.log('min_overlap '+min_overlap);
                         } else {
                           min_overlap == 3;
                         }

                         if (holdsjson) {
                           current_holds = JSON.parse(holdsjson)
                         } else {
                           current_holds = []
                         }
                         if (notholdsjson) {
                           current_notholds = JSON.parse(notholdsjson)
                         } else {
                           current_notholds = []
                         }
                         getProblemList(current_holds, current_notholds, setYear, setAngle, min_overlap, minGrade, maxGrade, 3,20, sortedBy,current_holdsetsSelected)


                     }

                     function sliderIsSliding(values, handle, unencoded, tap, positions) {

                         if ($sliderMin.position().left === $sliderMax.position().left) {

                             if (handle == 0) {
                                 $sliderMax.css("z-index", 4);
                             }
                             else {
                                 $sliderMax.css("z-index", 5);
                             }
                         }
                     }


                     moonSlider.noUiSlider.on('slide', sliderIsSliding);
                     moonSlider.noUiSlider.on('change', sliderValueChanged);




                     function slider2ValueChanged(values, handle, unencoded, tap, positions) {


                         sessionStorage.setItem('min_overlap', parseInt(values[0]));


                         var setYear = sessionStorage.getItem('setYear') || '2017';
                         var setAngle = sessionStorage.getItem('setAngle') || '40';
                         var sortedBy = sessionStorage.getItem('sortedBy');

                         current_holdsetsSelected = sessionStorage.getItem('holdsetsSelected')
                         if (holdsetsSelectedjson) {
                           current_holdsetsSelected = JSON.parse(holdsetsSelectedjson)
                         } else {
                           current_holdsetsSelected = []
                         }

                         holdsjson = sessionStorage.getItem('hold')
                         notholdsjson = sessionStorage.getItem('nothold')

                         if (holdsjson) {
                           current_holds = JSON.parse(holdsjson)
                         } else {
                           current_holds = []
                         }
                         if (notholdsjson) {
                           current_notholds = JSON.parse(notholdsjson)
                         } else {
                           current_notholds = []
                         }

                         getProblemList(current_holds,  current_notholds, setYear, setAngle, parseInt(values[0]), minGrade, maxGrade, 3,20, sortedBy,current_holdsetsSelected)


                     }
                     {% if max_holds > 3 %}
                     minOverlapSlider.noUiSlider.on('change', slider2ValueChanged);
                     {% endif %}




                     function updateSliderTicks()
                     {
                         var $nodes = $("#slider .noUi-value-large");

                         $nodes.each(function (index, e) {


                             if (index % 2 === 0) {

                                 e.innerHTML = ticks_labels[index];
                             }
                             else {
                                 e.innerHTML = " ";
                             }

                         });
                     }

                     updateSliderTicks();


                     $("button.btnGrade").on("click", function () {
                         var $button = $(this);


                         $button.toggleClass("unselected");

                         var grades = $("button.btnGrade:not('.unselected')")
                             .map(function () {
                                 return this.innerText;
                             })
                             .get()
                             .join(",");

                         console.log('Grades '+grades);



                     });






                     $("button.tabButton").on("click", function () {

                         var $tabButton = $(this);

                         $("button.tabButton").removeClass("selected");
                         $("div.moon-tab").removeClass("active");


                         var id = $tabButton.data("id");

                         $tabButton.addClass('selected');

                         $('div.moon-tab[data-id="' + id + '"]').addClass('active');


                     });











                     var selectedIndex = -1;
                     var currentProblem;

                     $(function () {





















                       Array.prototype.remove = function() {
                           var what, a = arguments, L = a.length, ax;
                           while (L && this.length) {
                               what = a[--L];
                               while ((ax = this.indexOf(what)) !== -1) {
                                   this.splice(ax, 1);
                               }
                           }
                           return this;
                       };





                        $(".holdsetBtn").click(function () {

                            holdsetsSelectedjson = sessionStorage.getItem('holdsetsSelected')
                            if (holdsetsSelectedjson) {
                              current_holdsetsSelected = JSON.parse(holdsetsSelectedjson)
                            } else {
                              current_holdsetsSelected = []
                            }
                            var $btn = $(this);

                            $btn.toggleClass('selected');

                            var holdsetSelected = $btn.val();

                            if ($btn.hasClass('selected')) {
                                current_holdsetsSelected.push(holdsetSelected)
                            } else {
                                current_holdsetsSelected.remove(holdsetSelected)
                            }
                            sessionStorage.setItem('holdsetsSelected',JSON.stringify(current_holdsetsSelected))
                            console.log($btn.val())
                            console.log(current_holdsetsSelected)


                            holdsetsSelectedjson = sessionStorage.getItem('holdsetsSelected')
                            if (holdsetsSelectedjson) {
                              current_holdsetsSelected = JSON.parse(holdsetsSelectedjson)
                            } else {
                              current_holdsetsSelected = []
                            }
                            console.log('holdsetSelected after resetting '+ current_holdsetsSelected)
                            var setYear = sessionStorage.getItem('setYear') || '2017';
                            var setAngle = sessionStorage.getItem('setAngle') || '40';
                            var minGrade = sessionStorage.getItem('minGrade') ||  '5+';
                            var maxGrade = sessionStorage.getItem('maxGrade') || '8B+';

                            var min_overlap = sessionStorage.getItem('min_overlap') || 3;
                            var sortedBy = sessionStorage.getItem('sortedBy') || '';

                            holdsjson = sessionStorage.getItem('hold')
                            notholdsjson = sessionStorage.getItem('nothold')

                            if (holdsjson) {
                              current_holds = JSON.parse(holdsjson)
                            } else {
                              current_holds = []
                            }
                            if (notholdsjson) {
                              current_notholds = JSON.parse(notholdsjson)
                            } else {
                              current_notholds = []
                            }

                            getProblemList(current_holds, current_notholds,  setYear, setAngle, min_overlap, minGrade, maxGrade, 3,20,sortedBy,current_holdsetsSelected)





                        });












                         $(".sortBtn").click(function () {

                             var $btn = $(this);

                             $(".sortBtn").removeClass('selected');

                             $btn.addClass('selected');
                             var sortedBy = $btn.text();
                             var setYear = sessionStorage.getItem('setYear') || '2017';
                             var setAngle = sessionStorage.getItem('setAngle') || '40';
                             var minGrade = sessionStorage.getItem('minGrade') ||  '5+';
                             var maxGrade = sessionStorage.getItem('maxGrade') || '8B+';

                             var min_overlap = sessionStorage.getItem('min_overlap') || 3;


                             var dsSort = [];

                             $("#sortedBy").text("Sorted by: " + sortedBy);

                             sessionStorage.setItem('sortedBy', sortedBy);

                             console.log($btn.text());

                             current_holdsetsSelected = sessionStorage.getItem('holdsetsSelected')
                             if (holdsetsSelectedjson) {
                               current_holdsetsSelected = JSON.parse(holdsetsSelectedjson)
                             } else {
                               current_holdsetsSelected = []
                             }
                             holdsjson = sessionStorage.getItem('hold')
                             notholdsjson = sessionStorage.getItem('nothold')

                             if (holdsjson) {
                               current_holds = JSON.parse(holdsjson)
                             } else {
                               current_holds = []
                             }
                             if (notholdsjson) {
                               current_notholds = JSON.parse(notholdsjson)
                             } else {
                               current_notholds = []
                             }

                             getProblemList(current_holds, current_notholds,  setYear, setAngle, min_overlap, minGrade, maxGrade, 3,20,sortedBy,current_holdsetsSelected)





                         });





                         $("#btnProblemSearch").click(function () {


                         });

                         $(".filter").click(function () {


                             var $btn = $(this);

                             $(".filter").removeClass('selected');

                             var field = $btn.data("field");
                             var filters = [];

                             if (field != 'None') {

                                 $btn.addClass('selected');




                             }
                             else {

                                 $("button.btnHoldset:not(.selected)").addClass("selected");

                                 $("button.btnConfig:not(.selected)").addClass("selected");




                             }



                         });



                     });







  document.getElementById("replaceable-content").scrollTop = 0;







                 </script>
